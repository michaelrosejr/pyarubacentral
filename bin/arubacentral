#!/usr/bin/env python3

import argparse
import os 

parser = argparse.ArgumentParser(description='Interact with Aruba Central')
# parser.add_argument('integers', metavar='N', type=int, nargs='+',
#                     help='an integer for the accumulator')
# parser.add_argument('--test', dest='accumulate', action='store_const',
#                     const=sum, default=max,
#                     help='sum the integers (default: find the max)')
parser.add_argument('--refresh', dest='profile',
                    help='Refresh access token for profile')
parser.add_argument('--configure', action="store_true",
                    help='Create configuration files for pyarubacentral module')

args = parser.parse_args()
# print(args.configure)

config_dir = os.environ["HOME"] + "/.arubacentral/"
yaml_files = ['accounts.yml', 'regions.yml', 'config.yml']

def check_config(args):
    if args.configure == True:
        print("Checking for existing configuration files....")
        for chkfile in yaml_files:
            pwd = config_dir+chkfile
            if os.path.exists(pwd) == True:
                print("\tFile exists: "+pwd)
                fexist = True
            # print(os.path.exists('~/.arubacentral/accounts.yml'))
            # print(os.environ["HOME"])
        if fexist == True:
            print("\nDo you want to overwrite these files? [Y/N]: ", end = '')
            yn = str(input())
            if yn.lower() == "y":
                for conffile in yaml_files:
                    print("Copying file " + conffile + " to " + config_dir + "....")
                    os.system('mv ' + config_dir+conffile + ' ' + config_dir+conffile + '.backup')
                    os.system('wget -O ' + config_dir+conffile + ' https://raw.githubusercontent.com/michaelrosejr/pyarubacentral/master/samplescripts/' + conffile + ".sample" )
                print("\nUse your favorite editor and edit the following files for your Aruba Central accounts:")
                for editconf in yaml_files:
                    print("\t" + config_dir+editconf )
            else: 
                print("Exiting...\n")    

def refresh(profile):
    import pyarubacentral
    session = pyarubacentral.start_session(profile)
    access_token = pyarubacentral.check_if_expired(profile, session)
    print("\n[{}]".format(profile))
    print("Access Token: "+access_token+ "\n")

def main():
    # print(args)
    if args.configure == True:
        check_config(args)
    elif args.profile:
        refresh(args.profile)


if __name__== "__main__":
   main()